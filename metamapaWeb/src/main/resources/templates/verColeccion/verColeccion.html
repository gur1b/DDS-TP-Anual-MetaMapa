<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(
          titulo=${coleccion.titulo()},
          linksAdicionales=~{:: #links-de-coleccion},
          scriptsAdicionales=~{:: #scripts-de-coleccion},
          contenido=~{:: #contenido-de-coleccion}
      )}">

<!-- ========== CSS ========== -->
<th:block id="links-de-coleccion">
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/pages-css/verColeccion.css}">

    <link rel="stylesheet"
          href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
</th:block>

<!-- ========== CONTENIDO ========== -->
<div id="contenido-de-coleccion">
    <main class="map-layout-container">
        <div id="mapa" class="map-panel"></div>

        <aside class="sidebar-panel">
            <header class="sidebar-header">COLECCIÓN</header>
            <section class="sidebar-content">
                <h2 th:text="${coleccion.titulo()}">Título colección</h2>
                <p th:text="${coleccion.descripcionColeccion()}">Descripción</p>

                <div th:if="${coleccion.modoDeNavegacion() == 'CURADA'}">
                    <label for="selectorModo">Modo de navegación:</label>

                    <select id="selectorModo" th:data-id="${coleccion.id()}">
                        <option value="CURADA" th:selected="${modoActual == 'CURADA'}">Curada</option>
                        <option value="IRRESTRICTA" th:selected="${modoActual == 'IRRESTRICTA'}">Irrestricta</option>
                    </select>
                </div>
                <div class="filtros-bloque" style="margin-bottom:1em;">
                    <button type="button" class="btn-toggle-filtros" aria-expanded="false">
                        Filtros
                    </button>
                    <form class="filtros-form" style="display:none;" method="get" id="form-filtros">
                        <input type="hidden" name="modo" th:value="${modoActual}">
                        <!-- Título -->
                        <div class="filtro-item">
                            <label for="titulo">Título:</label>
                            <input type="text" name="titulo" id="titulo" placeholder="Buscar por título">
                        </div>
                        <!-- Descripción -->
                        <div class="filtro-item">
                            <label for="descripcion">Descripción:</label>
                            <input type="text" name="descripcion" id="descripcion" placeholder="Buscar por descripción">
                        </div>
                        <!-- Etiquetas -->
                        <div class="filtro-item">
                            <label for="etiqueta">Etiquetas:</label>
                            <select id="etiqueta" name="etiqueta">
                                <option value="">- Todas -</option>
                                <option th:each="tag : ${etiquetas}" th:value="${tag}" th:text="${tag}"></option>
                            </select>
                        </div>
                        <!-- Categoría -->
                        <div class="filtro-item">
                            <label for="categoria">Categoría:</label>
                            <select id="categoria" name="categoria">
                                <option value="">- Todas -</option>
                                <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat}"></option>
                            </select>
                        </div>
                        <div class="filtro-item">
                            <label for="provincia">Provincia:</label>
                            <select name="provincia" id="provincia">
                                <option value="">- Todas -</option>
                                <option th:each="prov : ${provincias}" th:value="${prov.name()}" th:text="${prov.nombre}"></option>
                            </select>
                        </div>
                        <!-- FECHA DE SUCESO -->
                        <div class="filtro-item" style="margin-bottom:.3em;">
                            <span style="font-weight: bold; color: #a8732e;">Fecha de suceso</span>
                        </div>
                        <div class="filtro-item">
                            <label for="fechaDesdeSuceso">Desde:</label>
                            <input type="date" name="fechaDesdeSuceso" id="fechaDesdeSuceso">
                        </div>
                        <div class="filtro-item">
                            <label for="fechaHastaSuceso">Hasta:</label>
                            <input type="date" name="fechaHastaSuceso" id="fechaHastaSuceso">
                        </div>
                        <!-- FECHA DE CARGA -->
                        <div class="filtro-item" style="margin-bottom:.3em; margin-top:.8em;">
                            <span style="font-weight: bold; color: #a8732e;">Fecha de carga</span>
                        </div>
                        <div class="filtro-item">
                            <label for="fechaDesdeCarga">Desde:</label>
                            <input type="date" name="fechaDesdeCarga" id="fechaDesdeCarga">
                        </div>
                        <div class="filtro-item">
                            <label for="fechaHastaCarga">Hasta:</label>
                            <input type="date" name="fechaHastaCarga" id="fechaHastaCarga">
                        </div>

                        <!-- Multimedia -->
                        <div class="filtro-item">
                            <label>
                                <input type="checkbox" name="soloMultimedia"> Solo hechos con archivos/imágenes
                            </label>
                        </div>
                        <div style="margin-top:.7rem">
                            <button type="submit" class="btn-map" style="width:100%">
                                Filtrar
                            </button>
                        </div>
                    </form>
                </div>

                <h3 style="margin-top:1rem">Hechos</h3>
                <div class="hechos-accordion">

                    <!-- Acordeón por hecho -->
                    <details th:each="h : ${hechos}"
                             th:attr="data-hash=${h.hash()}, data-lat=${h.latitud()}, data-lon=${h.longitud()}">

                        <summary>
                            <div class="hecho-title" th:text="${h.nombre()}">Título del hecho</div>
                            <i class="chev fa-solid fa-chevron-right" aria-hidden="true"></i>
                        </summary>

                        <div class="hecho-detalle">

                            <div class="field">
                                <span class="field-label">Descripción:</span>
                                <span class="field-value"
                                      th:text="${h.descripcion()!=null ? h.descripcion() : 'No indica'}"
                                      th:classappend="${h.descripcion()==null} ? 'muted' : ''">
                                </span>
                            </div>

                            <div class="field">
                                <span class="field-label">Fecha del hecho:</span>
                                <span class="field-value"
                                      th:text="${h.fechaSuceso() != null} ?
                                               ${#temporals.format(h.fechaSuceso(), 'dd/MM/yyyy')} :
                                               'No indica'"
                                      th:classappend="${h.fechaSuceso() == null} ? 'muted' : ''">
                                </span>
                            </div>

                            <div class="field">
                                <span class="field-label">Hora del hecho:</span>
                                <span class="field-value"
                                    th:text="${h.horaSuceso() != null} ?
                                    ${#temporals.format(h.horaSuceso(), 'HH:mm a')} :
                                    'No indica'"
                                    th:classappend="${h.horaSuceso() == null} ? 'muted' : ''">
                                </span>
                            </div>

                            <div class="field">
                                <span class="field-label">Fecha de carga:</span>
                                <span class="field-value"
                                      th:text="${h.fechaCarga() != null} ?
                                               ${#temporals.format(h.fechaCarga(), 'dd/MM/yyyy')} :
                                               'No indica'"
                                      th:classappend="${h.fechaCarga() == null} ? 'muted' : ''">
                                </span>
                            </div>

                            <div class="field">
                                <span class="field-label">Categorias:</span>

                                <span class="field-value"
                                      th:if="${h.categorias()!=null and !#lists.isEmpty(h.categorias())}">
                                    <span class="chip"
                                          th:each="tag : ${h.categorias()}"
                                          th:text="${tag}"></span>
                                </span>

                                <span class="field-value muted"
                                      th:if="${h.categorias()==null or #lists.isEmpty(h.categorias())}">
                                    No indica
                                </span>
                            </div>

                            <div class="field">
                                <span class="field-label">Etiquetas:</span>

                                <span class="field-value"
                                      th:if="${h.etiquetas()!=null and !#lists.isEmpty(h.etiquetas())}">
                                    <span class="chip"
                                          th:each="tag : ${h.etiquetas()}"
                                          th:text="${tag}"></span>
                                </span>

                                <span class="field-value muted"
                                      th:if="${h.etiquetas()==null or #lists.isEmpty(h.etiquetas())}">
                                    No indica
                                </span>
                            </div>

                            <div class="field">
                                <span class="field-label">Contribuyente:</span>
                                <span class="field-value"
                                      th:text="${h.contribuyente()!=null ? h.contribuyente() : 'No indica/Anónimo'}"
                                      th:classappend="${h.contribuyente()==null} ? 'muted' : ''">

                                </span>
                            </div>

                            <!-- Multimedia -->
                            <div class="field">
                                <span class="field-label">Multimedia:</span>

                                <span class="field-value" th:if="${h.multimedia()!=null and !h.multimedia().isEmpty()}">
                                    <div class="multimedia-gallery">
                                        <button type="button"
                                                class="multimedia-item"
                                                th:each="m : ${h.multimedia()}"
                                                th:data-src="@{'/uploads/hechos/' + ${m}}"
                                                th:data-alt="${h.nombre()} + ' - multimedia adjunta'"
                                                th:data-type="${
                                                    (#strings.endsWith(m.toLowerCase(), '.mp4') or
                                                     #strings.endsWith(m.toLowerCase(), '.webm') or
                                                     #strings.endsWith(m.toLowerCase(), '.ogg') or
                                                     #strings.endsWith(m.toLowerCase(), '.mkv')) ? 'video' : 'image'
                                                 }"><!-- Si es imagen --><img th:if="${#strings.endsWith(m.toLowerCase(), '.jpg') or #strings.endsWith(m.toLowerCase(), '.jpeg') or #strings.endsWith(m.toLowerCase(), '.png') or #strings.endsWith(m.toLowerCase(), '.gif') or #strings.endsWith(m.toLowerCase(), '.webp')}" th:src="@{'/uploads/hechos/' + ${m}}" th:alt="${h.nombre()} + ' - imagen adjunta'"
                                                                              class="multimedia-thumb" />

                                        <!-- Si es video (preview simple con ícono) -->
                                      <div class="multimedia-video-thumb"
                                           th:if="${#strings.endsWith(m.toLowerCase(), '.mp4') or #strings.endsWith(m.toLowerCase(), '.webm') or #strings.endsWith(m.toLowerCase(), '.ogg') or #strings.endsWith(m.toLowerCase(), '.mkv')}">
                                        <i class="fa-solid fa-play"></i>
                                        <span class="multimedia-video-label" th:text="${m}">video.mp4</span>
                                      </div>

                                    </button>
                                  </div>
                                </span>

                                                              <span class="field-value muted" th:if="${h.multimedia()==null or h.multimedia().isEmpty()}">
                                  No tiene archivos adjuntos.
                                </span>
                            </div>




                            <!-- Botón Ver -->
                            <div class="field" style="margin-top:0.6rem;">
                                <a href="#" class="btn-map js-ver-hecho" th:attr="data-hash=${h.hash}">
                                    <i class="fa-solid fa-location-dot"></i> Ver hecho
                                </a>
                            </div>

                            <div class="field" style="margin-top:0.6rem;">
                                <a class="btn-solicitud"
                                   th:href="@{|/solicitudEliminacion/${h.id}|}">
                                    Solicitar eliminación
                                </a>
                            </div>

                        </div>
                    </details>

                    <p th:if="${#lists.isEmpty(hechos)}" class="muted">
                        No hay hechos para esta colección.
                    </p>
                </div>
            </section>
        </aside>
        <!-- Modal multimedia (imagen o video) -->
        <div id="media-modal" class="img-modal" aria-hidden="true">
            <div class="img-modal-backdrop"></div>

            <div class="img-modal-content" role="dialog" aria-modal="true">
                <button class="img-modal-close" type="button" aria-label="Cerrar">&times;</button>

                <img id="media-modal-img" src="" alt="" style="display:none;">
                <video id="media-modal-video" style="display:none;" controls playsinline>
                    Tu navegador no soporta la reproducción de video.
                </video>

                <div class="media-modal-actions" style="margin-top:10px; display:none;" id="media-modal-actions">
                    <a id="media-modal-download" class="btn-map" href="#" download>
                        <i class="fa-solid fa-download"></i> Descargar
                    </a>
                    <a id="media-modal-open" class="btn-map" href="#" target="_blank" rel="noopener">
                        <i class="fa-solid fa-up-right-from-square"></i> Abrir en pestaña
                    </a>
                </div>

                <p id="media-modal-caption" class="img-modal-caption"></p>
            </div>
        </div>


    </main>
</div>

<!-- ========== JS ========== -->
<th:block id="scripts-de-coleccion">
    <!-- Datos del backend -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.hechos = /*[[${hechos}]]*/ [];
        /*]]>*/
    </script>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- JS principal -->
    <script>
        // ===== Helpers menores =====
        const toNum = v => {
            if (v == null) return null;
            const n = parseFloat(String(v).replace(',', '.'));
            return Number.isFinite(n) ? n : null;
        };

        // Detectar videos no soportados y mostrar botón de descarga
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.multimedia-thumb').forEach(function (el) {
                if (el.tagName === 'VIDEO') {
                    el.addEventListener('error', function () {
                        mostrarBotonDescarga(el);
                    });
                    // Si el video no puede reproducirse, mostrar el botón
                    el.addEventListener('loadeddata', function () {
                        if (el.readyState < 2) {
                            mostrarBotonDescarga(el);
                        }
                    });
                }
            });
        });

        // Función global para usar desde onerror en el HTML
        function mostrarBotonDescarga(videoEl) {
            videoEl.style.display = 'none';
            const parent = videoEl.parentElement;
            const downloadBtn = parent.querySelector('.download-btn');
            if (downloadBtn) {
                downloadBtn.style.display = 'inline-block';
            }
        }

        // ===== Datos para el mapa =====
        const puntos = (window.hechos || [])
            .map(h => ({
                hash: h.hash,
                nombre: h.nombre,
                lat: toNum(h.latitud),
                lon: toNum(h.longitud)
            }))
            .filter(p => p.lat != null && p.lon != null);

        // ===== Mapa =====
        const defaultCenter = [-34.6037, -58.3816], defaultZoom = 11;
        const map = L.map('mapa', { maxZoom: 19 })
            .setView(
                puntos.length ? [puntos[0].lat, puntos[0].lon] : defaultCenter,
                puntos.length ? 13 : defaultZoom
            );

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // CLUSTERING
        const markersByHash = {};

        const markerCluster = L.markerClusterGroup({
            maxClusterRadius: 40,
            spiderfyOnEveryZoom: true,
            showCoverageOnHover: false
        });

        puntos.forEach(p => {
            const popupHtml = `
              <div class="popup-card">
                <div class="popup-title"><b>${p.nombre ?? '(sin título)'}</b></div>
                <a href="#" class="btn-map js-ver-hecho" data-hash="${p.hash}">
                  <i class="fa-solid fa-list"></i> Ver hecho
                </a>
              </div>
            `;

            const m = L.marker([p.lat, p.lon]).bindPopup(popupHtml);

            markersByHash[p.hash] = m;
            markerCluster.addLayer(m);
        });

        map.addLayer(markerCluster);

        if (puntos.length > 1) {
            const bounds = L.latLngBounds(puntos.map(p => [p.lat, p.lon]));
            map.fitBounds(bounds.pad(0.15));
        }

        // Al abrir cualquier popup: solo centramos suave (si quisieras)
        map.on('popupopen', (e) => {
            const ll = e.popup.getLatLng();
            // map.flyTo(ll, Math.max(map.getZoom(), 15), { duration: .4 });
        });

        // ===== Helpers de sincronización mapa <-> sidebar =====
        const sidebarPanel = document.querySelector('.sidebar-panel');

        function focusMarker(hash, { zoom = 15, openPopup = true } = {}) {
            const m = markersByHash[hash];
            if (!m) return;
            const latlng = m.getLatLng();
            map.flyTo(latlng, Math.max(map.getZoom(), zoom), { duration: .45 });
            if (openPopup) m.openPopup();
        }

        function openDetails(hash, { scroll = true, highlight = true, closeOthers = true } = {}) {
            const details = document.querySelector(`details[data-hash="${hash}"]`);
            if (!details) return;

            if (closeOthers) {
                document.querySelectorAll('.hechos-accordion details[open]')
                    .forEach(d => { if (d !== details) d.removeAttribute('open'); });
            }
            details.setAttribute('open', true);

            if (highlight) {
                document.querySelectorAll('.hechos-accordion details')
                    .forEach(d => d.classList.remove('highlight'));
                details.classList.add('highlight');
            }

            if (scroll && sidebarPanel) {
                sidebarPanel.scrollTo({
                    top: details.offsetTop - 40,
                    behavior: 'smooth'
                });
            }
        }

        // ===== Click en "Ver hecho" (popup o sidebar) =====
        document.addEventListener('click', (e) => {
            const link = e.target.closest('.js-ver-hecho');
            if (!link) return;

            const clickedAnchor = e.target.closest('a');
            if (clickedAnchor) {
                const href = clickedAnchor.getAttribute('href');
                if (href && href !== '#') return; // dejar navegar normal
            }

            e.preventDefault();
            const hash = link.dataset.hash;

            focusMarker(hash, { openPopup: true });
            openDetails(hash);
        });

        function fitLayout() {
            const header = document.querySelector('header.site-header');
            const footer = document.querySelector('footer.site-footer');
            const cont   = document.querySelector('.map-layout-container');
            if(!cont) return;

            const h = window.innerHeight - (header?.offsetHeight||0) - (footer?.offsetHeight||0) - 16;
            cont.style.height = Math.max(360, h) + 'px';
        }

        window.addEventListener('load', () => {
            fitLayout();
            setTimeout(() => map.invalidateSize(), 80);
        });

        window.addEventListener('resize', () => {
            fitLayout();
            map.invalidateSize();
        });

        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.querySelector('.btn-toggle-filtros');
            const form = document.querySelector('.filtros-form');
            if (btn && form) {
                btn.addEventListener('click', () => {
                    const open = form.style.display === 'block';
                    form.style.display = open ? 'none' : 'block';
                    btn.setAttribute('aria-expanded', !open);
                });
            }
        });

        // Cambiar modo de navegación recargando la página
        document.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('selectorModo');
            if (!selector) return;

            selector.addEventListener('change', () => {
                const id = selector.dataset.id;
                const modo = selector.value;
                const url = `/colecciones/${id}?modo=${modo}`;
                console.log('Navegando a:', url);
                window.location.href = url;
            });
        });

        // ===== POPUP MULTIMEDIA (IMAGEN + VIDEO) =====
        (function () {
            const modal = document.getElementById('media-modal');
            if (!modal) return;

            const modalImg     = document.getElementById('media-modal-img');
            const modalVideo   = document.getElementById('media-modal-video');
            const modalCaption = document.getElementById('media-modal-caption');
            const btnClose     = modal.querySelector('.img-modal-close');

            const actionsWrap  = document.getElementById('media-modal-actions');
            const btnDownload  = document.getElementById('media-modal-download');
            const btnOpenTab   = document.getElementById('media-modal-open');

            function openModal({ type, src, alt }) {
                if (!src) return;

                // reset
                modalImg.style.display = 'none';
                modalVideo.style.display = 'none';
                modalVideo.pause();
                modalVideo.removeAttribute('src'); // importante para “cortar” descarga
                modalVideo.load();

                // set caption + acciones
                modalCaption.textContent = alt || '';
                if (actionsWrap) actionsWrap.style.display = 'flex';
                if (btnDownload) btnDownload.href = src;
                if (btnOpenTab)  btnOpenTab.href = src;

                // show correct media
                if (type === 'video') {
                    modalVideo.style.display = 'block';
                    modalVideo.src = src;
                    modalVideo.load();
                } else {
                    modalImg.style.display = 'block';
                    modalImg.src = src;
                    modalImg.alt = alt || '';
                }

                modal.classList.add('is-visible');
                modal.setAttribute('aria-hidden', 'false');
            }

            function closeModal() {
                modal.classList.remove('is-visible');
                modal.setAttribute('aria-hidden', 'true');

                // limpiar para que no siga sonando / descargando
                modalImg.src = '';
                modalImg.alt = '';

                modalVideo.pause();
                modalVideo.removeAttribute('src');
                modalVideo.load();

                modalCaption.textContent = '';
                if (actionsWrap) actionsWrap.style.display = 'none';
            }

            // Click en miniatura
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.multimedia-item');
                if (!btn) return;

                e.preventDefault();

                const src  = btn.dataset.src;
                const alt  = btn.dataset.alt || '';
                const type = btn.dataset.type || 'image';

                openModal({ type, src, alt });
            });

            // cerrar
            btnClose?.addEventListener('click', (e) => {
                e.preventDefault();
                closeModal();
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.classList.contains('img-modal-backdrop')) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('is-visible')) {
                    closeModal();
                }
            });
        })();


    </script>
</th:block>

</html>
